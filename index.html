<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestionale La Contessa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <meta name="theme-color" content="#2f7d65">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- Protezione accesso: redirect a login se non autenticato -->
  <script>
    // Verifica autenticazione
    if (sessionStorage.getItem('isLoggedIn') !== 'true' || !sessionStorage.getItem('accessToken')) {
      window.location.href = 'login.html';
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:wght@500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/mobile-responsive.css">

  <!-- Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  
  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- Logo Sidebar -->
<aside class="logo-sidebar">
  <div class="logo-container">
    <img src="assets/logo.png" alt="Logo La Contessa" class="sidebar-logo" />
    <div class="logo-title">La Contessa</div>
    <div class="logo-subtitle">Ristorante</div>
  </div>
</aside>

<header class="topbar">
  <div style="display:flex;align-items:center;gap:1rem;width:100%;">
    <span class="gestionale-deco">Gestionale Magazzino</span>
  </div>
  <nav>
    <div class="nav-tabs" role="tablist" aria-label="Sezioni">
      <button data-page="new" class="active" role="tab" aria-selected="true">Home</button>
      <button data-page="archive" role="tab">Archivio</button>
      <button data-page="stats" role="tab">Statistiche</button>
    </div>
  </nav>
  <button id="logoutBtn" class="logout-btn" title="Esci">
    <span class="logout-text">Esci</span>
  </button>
</header>

<main>

<!-- NUOVO ACQUISTO -->
<section id="page-new" class="page active">
  <div class="card">
    <div class="new-main-flex wide-forms">
      <div style="display:flex;flex-direction:column;gap:0.8rem;flex:1 1 32%;min-width:280px;">
        <!-- PARAGRAFO 1: Ricerca prodotto -->
        <div class="search-section big-tile wide-tile" style="margin-bottom:0;">
          <div class="form-header">
            <span class="form-icon">‚Üí</span>
            <h2>Cerca Prodotto</h2>
          </div>
          <p class="subtitle">Trova rapidamente prodotti esistenti</p>
          <label for="searchProduct">Nome prodotto</label>
          <input id="searchProduct" class="search-bar" type="text" placeholder="Inizia a digitare...">
          <ul id="searchResults" class="search-results"></ul>
          <div id="productDetails" class="product-details" style="display:none;"></div>
        </div>

        <!-- BADGE STATISTICHE SOPRA -->
        <div class="stats-badges-row">
          <div class="stat-badge stat-badge-purple">
            <span class="stat-badge-label">Spese Totali</span>
            <span class="stat-badge-value" id="totalSpent">‚Ç¨ 0</span>
          </div>
          <div class="stat-badge stat-badge-teal">
            <span class="stat-badge-label">Fornitori Attivi</span>
            <span class="stat-badge-value" id="activeSuppliers">0</span>
          </div>
          <div class="stat-badge stat-badge-amber">
            <span class="stat-badge-label">Prodotti Registrati</span>
            <span class="stat-badge-value" id="registeredProducts">0</span>
          </div>
        </div>

        <!-- PILLOLA STATISTICHE ANDAMENTO SPESE -->
        <div class="spending-trends-pill" id="spendingTrendsPill">
          <div class="pill-header">
            <div>
              <span class="trend-icon">üìà</span>
              <h3 class="pill-title">Andamento Spese</h3>
              <span class="period-total-badge">
                <span class="period-total-label">Totale:</span>
                <span class="period-total-value" id="periodTotal">‚Ç¨ 0</span>
              </span>
            </div>
            <select id="trendsPeriod" class="trends-filter">
              <option value="7">7g</option>
              <option value="30" selected>30g</option>
              <option value="90">90g</option>
              <option value="180">6m</option>
              <option value="365">1a</option>
            </select>
          </div>
          <div class="trends-chart-wrapper">
            <canvas id="trendsChart"></canvas>
          </div>
        </div>
      </div>

      <!-- PARAGRAFO 2: Nuovo prodotto -->
      <div class="add-section big-tile wide-tile">
        <div class="form-header">
          <span class="form-icon">+</span>
          <h2>Nuovo Prodotto</h2>
        </div>
        <p class="subtitle">Registra un nuovo acquisto</p>
        <div class="grid">
          <div>
            <label for="productSelect">Prodotto</label>
            <select id="productSelect" class="fixed-select"></select>
            <input id="newProduct" placeholder="Nuovo prodotto" style="margin-top:0.3rem;">
          </div>
          <div>
            <label for="supplierSelect">Fornitore</label>
            <select id="supplierSelect" class="fixed-select"></select>
            <input id="newSupplier" placeholder="Nuovo fornitore" style="margin-top:0.3rem;">
          </div>
          <div>
            <label for="quantity">Quantit√†</label>
            <div style="display:flex;gap:0.4rem;">
              <input type="number" id="quantity" step="0.01" placeholder="0.00" style="flex:1;margin:0;">
              <select id="unit" style="width:90px;margin:0;">
                <option value="kg">Kg</option>
                <option value="litri">Litro/i</option>
                <option value="pezzi">Pezzo/i</option>
              </select>
            </div>
          </div>
          <div>
            <label for="price" id="priceLabel">Prezzo (‚Ç¨ al kg)</label>
            <input type="number" id="price" step="0.01" placeholder="0.00">
          </div>
          <div>
            <label for="purchaseDate">Data</label>
            <input type="date" id="purchaseDate">
          </div>
          <div>
            <label for="description">Note</label>
            <input id="description" placeholder="Descrizione...">
          </div>
          <div>
            <label for="rating">Qualit√† prodotto</label>
            <div id="ratingStars" style="display:flex;align-items:center;gap:0.3rem;margin-top:0.3rem;cursor:pointer;">
              <span class="star" data-value="0.5" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
              <span class="star" data-value="1" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
              <span class="star" data-value="1.5" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
              <span class="star" data-value="2" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
              <span class="star" data-value="2.5" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
              <span class="star" data-value="3" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
              <span class="star" data-value="3.5" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
              <span class="star" data-value="4" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
              <span class="star" data-value="4.5" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
              <span class="star" data-value="5" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
              <input type="hidden" id="rating" value="0">
            </div>
          </div>
        </div>
        <button class="primary" id="savePurchase">Salva</button>
      </div>
    </div>
    <!-- PARAGRAFO 3: Scansione Fattura -->
    <div class="ia-tile wide-tile" style="flex:1 1 32%;min-width:280px;">
      <div class="info-header">
        <span class="info-icon">‚óâ</span>
        <span class="info-title">Scansione Fattura</span>
      </div>
      <p class="info-desc">Scatta una foto della fattura e l'AI estrarr√† automaticamente i dati</p>
      <button class="ia-btn" id="scanInvoiceBtn">
        <span class="ia-btn-icon">üì∑</span> Scansiona
      </button>
    </div>
  </div>
</section>

<!-- ARCHIVIO -->
<section id="page-archive" class="page">
  <div class="card">
    <h2>Archivio Acquisti</h2>
    <p class="subtitle">Gestisci tutti gli acquisti registrati</p>

    <!-- FILTRI -->
    <div class="filters">
      <select id="filterProduct" class="fixed-select"></select>
      <select id="filterSupplier" class="fixed-select"></select>

      <select id="filterPriceMode">
        <option value="">Prezzo</option>
        <option value="asc">Crescente</option>
        <option value="desc">Decrescente</option>
        <option value="exact">Prezzo esatto</option>
      </select>
      <input type="number" id="filterPriceExact" class="hidden" placeholder="‚Ç¨ esatto">

      <select id="filterDateMode">
        <option value="">Data</option>
        <option value="recent">Pi√π recente</option>
        <option value="old">Meno recente</option>
        <option value="range">Intervallo</option>
      </select>
      <div id="dateRange" class="hidden">
        <input type="date" id="dateFrom">
        <input type="date" id="dateTo">
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>üïê</th>
          <th>Data</th>
          <th>Prodotto</th>
          <th>Fornitore</th>
          <th>Prezzo Cad.</th>
          <th>Quantit√†</th>
          <th>Unit√†</th>
          <th>Qualit√†</th>
          <th>Descrizione</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody id="archiveTable"></tbody>
    </table>

    <div class="pagination">
      <button id="prevPage">‚Üê</button>
      <span id="pageInfo"></span>
      <button id="nextPage">‚Üí</button>
    </div>

    <div class="export">
      <button id="exportExcel">Excel</button>
      <button id="exportPDF">PDF</button>
    </div>
  </div>
</section>


<!-- STATISTICHE -->
<section id="page-stats" class="page">
  <div class="card">

    <div class="stats-tabs-wrapper">
      <div class="stats-tabs">
        <button id="aiStatsTab" class="stats-tab active" type="button">Analisi con AI</button>
        <button id="classicStatsTab" class="stats-tab" type="button">Statistiche</button>
      </div>
    </div>

    <!-- SEZIONE STATISTICHE CON AI (ora prima e default) -->
    <div id="aiStatsSection">
      <h2>Analisi Intelligente Prodotti </h2>
      <p class="subtitle">L'AI confronta tutti gli acquisti e ti consiglia il migliore</p>
      <div class="filters">
        <select id="statsProduct" class="fixed-select">
          <option value="">Seleziona un prodotto</option>
        </select>
        <select id="statsSupplier" class="fixed-select">
          <option value="">Tutti i fornitori</option>
        </select>
      </div>
      <div class="ai-intro">
        <p>
          L'analisi AI valuta tutti gli acquisti del prodotto selezionato e confronta i fornitori considerando:
          <strong>prezzo unitario</strong>, <strong>qualit√†</strong>, <strong>rapporto qualit√†-prezzo</strong>, <strong>affidabilit√† del fornitore</strong> e <strong>note</strong>.
          Riceverai una classifica dei migliori acquisti e un riepilogo per scegliere in modo intelligente.
        </p>
      </div>
      <!-- Pulsante Analizza con AI -->
      <button id="analyzeWithAI" class="ai-analyze-btn" disabled>
        <span class="ai-icon">‚ú®</span>
        <span>Analizza con AI</span>
      </button>
      <!-- Loading -->
      <div id="aiLoading" class="ai-loading" style="display:none;">
        <div class="loading-spinner"></div>
        <p>L'AI sta analizzando tutti gli acquisti...</p>
      </div>
      <!-- Risultati AI -->
      <div id="aiResults" class="ai-results" style="display:none;"></div>
    </div>

    <!-- SEZIONE STATISTICHE (ora seconda) -->
    <div id="classicStatsSection" style="display:none;">
      <div class="stats-professional-header">
        <h2>Dashboard Statistiche</h2>
        <p class="subtitle">Analisi completa e reportistica del magazzino</p>
      </div>
      
      <!-- KPI Cards Professionali -->
      <div class="stats-kpi-professional">
        <div class="kpi-pro-card">
          <div class="kpi-pro-label">Spesa Totale</div>
          <div class="kpi-pro-value" id="kpiTotalSpent">‚Ç¨ 0</div>
        </div>
        <div class="kpi-pro-card">
          <div class="kpi-pro-label">Fornitori Attivi</div>
          <div class="kpi-pro-value" id="kpiSuppliers">0</div>
        </div>
        <div class="kpi-pro-card">
          <div class="kpi-pro-label">Prodotti Registrati</div>
          <div class="kpi-pro-value" id="kpiProducts">0</div>
        </div>
        <div class="kpi-pro-card">
          <div class="kpi-pro-label">Spesa Media</div>
          <div class="kpi-pro-value" id="kpiAvgPurchase">‚Ç¨ 0</div>
        </div>
      </div>

      <!-- Grafici Professionali con stile coerente -->
      <div class="stats-charts-grid">
        
        <!-- Grafico 1: Andamento Spese Mensili -->
        <div class="stats-chart-pill">
          <div class="stats-chart-header">
            <h3 class="stats-chart-title">Andamento Spese Mensili</h3>
            <p class="stats-chart-subtitle">Analisi temporale delle spese nel tempo</p>
          </div>
          <div class="stats-chart-canvas">
            <canvas id="monthlyTrendChart"></canvas>
          </div>
        </div>

        <!-- Grafico 2: Spese per Fornitore -->
        <div class="stats-chart-pill">
          <div class="stats-chart-header">
            <h3 class="stats-chart-title">Spese per Fornitore</h3>
            <p class="stats-chart-subtitle">Distribuzione degli acquisti tra fornitori</p>
          </div>
          <div class="stats-chart-canvas">
            <canvas id="supplierSpendingChart"></canvas>
          </div>
        </div>

        <!-- Grafico 3: Top Prodotti -->
        <div class="stats-chart-pill">
          <div class="stats-chart-header">
            <h3 class="stats-chart-title">Prodotti Pi√π Richiesti</h3>
            <p class="stats-chart-subtitle">Classifica per quantit√† acquistata</p>
          </div>
          <div class="stats-chart-canvas">
            <canvas id="topProductsChart"></canvas>
          </div>
        </div>

        <!-- Grafico 4: Frequenza Ordini -->
        <div class="stats-chart-pill">
          <div class="stats-chart-header">
            <h3 class="stats-chart-title">Frequenza Ordini</h3>
            <p class="stats-chart-subtitle">Numero di ordini per fornitore</p>
          </div>
          <div class="stats-chart-canvas">
            <canvas id="orderFrequencyChart"></canvas>
          </div>
        </div>

      </div>
    </div>
  </div>
</section>

</main>

<footer>
  <p>¬© 2026 Gestionale Ristorante La Contessa</p>
</footer>

<!-- DIALOG DETTAGLI PRODOTTO -->
<dialog id="productDialog" class="product-dialog">
  <div id="productDialogContent"></div>
  <button id="closeProductDialog" class="primary" style="margin-top:1.2rem;">Chiudi</button>
</dialog>

<!-- DIALOG RIACQUISTO PRODOTTO -->
<dialog id="repurchaseDialog" class="product-dialog">
  <h2 style="margin-top:0;">Riacquista Prodotto</h2>
  <div id="repurchaseContent" style="margin:1rem 0;"></div>
  <div style="display:grid;gap:0.8rem;margin:1rem 0;">
    <div>
      <label for="repurchaseQuantity">Quantit√†</label>
      <input type="number" id="repurchaseQuantity" step="0.01" placeholder="0.00">
    </div>
    <div>
      <label for="repurchasePrice">Prezzo (‚Ç¨)</label>
      <input type="number" id="repurchasePrice" step="0.01" placeholder="0.00">
      <div id="lastPriceInfo" style="font-size:0.75rem;color:var(--muted);margin-top:0.3rem;"></div>
    </div>
  </div>
  <div style="display:flex;gap:0.6rem;">
    <button id="saveRepurchase" class="primary" style="flex:1;">Salva Riacquisto</button>
    <button id="closeRepurchaseDialog" class="primary" style="flex:1;background:var(--muted);">Annulla</button>
  </div>
</dialog>

<!-- DIALOG MODIFICA PRODOTTO -->
<dialog id="editDialog" class="product-dialog">
  <h2 style="margin-top:0;">Modifica Prodotto</h2>
  <div style="display:grid;gap:0.8rem;margin:1rem 0;">
    <div>
      <label for="editProduct">Prodotto</label>
      <input type="text" id="editProduct">
    </div>
    <div>
      <label for="editSupplier">Fornitore</label>
      <input type="text" id="editSupplier">
    </div>
    <div>
      <label for="editPrice">Prezzo (‚Ç¨)</label>
      <input type="number" id="editPrice" step="0.01">
    </div>
    <div>
      <label for="editQuantity">Quantit√†</label>
      <input type="number" id="editQuantity" step="0.01">
    </div>
    <div>
      <label for="editUnit">Unit√†</label>
      <select id="editUnit">
        <option value="kg">Kg</option>
        <option value="litri">Litro/i</option>
        <option value="pezzi">Pezzo/i</option>
      </select>
    </div>
    <div>
      <label for="editDate">Data</label>
      <input type="date" id="editDate">
    </div>
    <div>
      <label for="editDescription">Note</label>
      <input type="text" id="editDescription">
    </div>
    <div>
      <label for="editRating">Qualit√† prodotto</label>
      <div id="editRatingStars" style="display:flex;align-items:center;gap:0.3rem;margin-top:0.3rem;cursor:pointer;">
        <span class="edit-star" data-value="0.5" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
        <span class="edit-star" data-value="1" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
        <span class="edit-star" data-value="1.5" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
        <span class="edit-star" data-value="2" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
        <span class="edit-star" data-value="2.5" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
        <span class="edit-star" data-value="3" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
        <span class="edit-star" data-value="3.5" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
        <span class="edit-star" data-value="4" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
        <span class="edit-star" data-value="4.5" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
        <span class="edit-star" data-value="5" style="font-size:1.8rem;color:#d1d5db;transition:all 0.2s;">‚òÖ</span>
        <input type="hidden" id="editRating" value="0">
      </div>
    </div>
  </div>
  <div style="display:flex;gap:0.6rem;">
    <button id="saveEdit" class="primary" style="flex:1;">Salva Modifiche</button>
    <button id="closeEditDialog" class="primary" style="flex:1;background:var(--muted);">Annulla</button>
  </div>
</dialog>

<div id="toast">Salvato</div>

  <!-- Stile logout button -->
  <style>
    .logout-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.7rem 1.2rem;
      border: 1.5px solid var(--border);
      border-radius: 50px;
      color: var(--primary);
      background: white;
      font-size: 1.15rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.18s cubic-bezier(.4,0,.2,1);
      margin-left: 2.5rem;
      margin-right: 0.5rem;
      box-shadow: 0 1px 2px rgba(47,125,101,0.03);
      position: relative;
      overflow: hidden;
      min-width: 48px;
      min-height: 48px;
      gap: 0;
    }
    .logout-btn svg {
      width: 1.6em;
      height: 1.6em;
      transition: transform 0.18s cubic-bezier(.4,0,.2,1);
      color: var(--primary);
      margin: 0;
    }
    .logout-btn:hover {
      background: linear-gradient(90deg, #fee2e2 0%, #fff 100%);
      border-color: #fca5a5;
      color: #b91c1c;
      box-shadow: 0 4px 16px rgba(252,165,165,0.10);
    }
    .logout-btn:hover svg {
      transform: translateX(4px);
      color: #b91c1c;
    }
    @media (max-width: 768px) {
      .logout-btn { 
        padding: 0.5rem 0.7rem; 
        font-size: 1.1rem;
        min-width: 40px;
        min-height: 40px;
        margin-left: 1rem;
      }
    }
  </style>

  <script src="js/supabase.js"></script>
  <script src="js/app.js"></script>
  <script src="js/config.js"></script>
  <script src="js/ai-analyzer.js"></script>
  
  <!-- Logout script -->
  <script>
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      if (confirm('Vuoi effettuare il logout?')) {
        // Logout sicuro da Supabase Auth
        const supabaseUrl = 'https://zlyikcrrwjxmvoigqpdi.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpseWlrY3Jyd2p4bXZvaWdxcGRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NzIxMTEsImV4cCI6MjA4MzQ0ODExMX0.QaRjSOSWjq0zBZtIvM0fSgqJSgIxpfwaHEfyB-j-Q5w';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        await supabase.auth.signOut();
        sessionStorage.clear();
        window.location.href = 'login.html';
      }
    });
  </script>

  <!-- Migliora bottone Esci: solo icona SVG -->
  <script>
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.innerHTML = `<svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.5 15.5V16.5C13.5 17.3284 12.8284 18 12 18H5C4.17157 18 3.5 17.3284 3.5 16.5V3.5C3.5 2.67157 4.17157 2 5 2H12C12.8284 2 13.5 2.67157 13.5 3.5V4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M16.5 10L8.5 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M12.5 6.5L16.5 10L12.5 13.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`;
    }
  </script>

